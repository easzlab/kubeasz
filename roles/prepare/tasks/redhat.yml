- name: 删除centos/redhat默认安装
  package:
    name:
      - firewalld
      - python-firewall
      - firewalld-filesystem
    state: absent
  ignore_errors: true

- name: 安装基础软件包
  package: 
    name:
      - bash-completion     # bash命令补全工具，需要重新登录服务器生效
      - conntrack-tools     # ipvs 模式需要
      - ipset               # ipvs 模式需要
      - ipvsadm             # ipvs 模式需要
      - libseccomp          # 安装containerd需要
      - lvm2                # 安装Local PV LVM 存储插件需要
      - nfs-utils           # 挂载nfs 共享文件需要 (创建基于 nfs的PV 需要)
      - psmisc              # 安装psmisc 才能使用命令killall，keepalive的监测脚本需要
      - rsync               # 文件同步工具，分发证书等配置文件需要
      - socat               # 用于port forwarding
    state: present
  when: 'INSTALL_SOURCE != "offline"'

# 离线安装基础软件包
- import_tasks: offline.yml
  when: 'INSTALL_SOURCE == "offline"'

- name: 临时关闭 selinux
  shell: "setenforce 0"
  failed_when: false

# 部分系统没有文件/etc/selinux/config
- name: 检查文件/etc/selinux/config
  stat: path="/etc/selinux/config"
  register: se

- name: 永久关闭 selinux
  lineinfile:
    dest: /etc/selinux/config
    regexp: "^SELINUX="
    line: "SELINUX=disabled"
  ignore_errors: true
  when: se.stat.isreg is defined

- name: 永久关闭 selinux
  shell: "echo 'SELINUX=disabled' > /etc/selinux/config && \
          echo 'SELINUXTYPE=targeted' >> /etc/selinux/config"
  when: se.stat.isreg is not defined

# 优化设置 journal 日志相关，避免日志重复搜集，浪费系统资源
- name: 禁止rsyslog获取journald日志1
  lineinfile:
    dest: /etc/rsyslog.conf
    state: present
    regexp: 'ModLoad imjournal'
    line: '#$ModLoad imjournal # provides access to the systemd journal'
  ignore_errors: true

- name: 禁止rsyslog获取journald日志2
  lineinfile:
    dest: /etc/rsyslog.conf
    state: present
    regexp: 'IMJournalStateFile'
    line: '#$IMJournalStateFile imjournal.state'
  ignore_errors: true

- name: 重启rsyslog服务
  service: name=rsyslog state=restarted
  ignore_errors: true

# RockyLinux 9 内核优化, 解决部分容器无法启动的问题
- name: fs.inotify.max_user_instances up to 8192
  sysctl:
    name: fs.inotify.max_user_instances
    value: 8192
    state: present
    reload: true
  when: ansible_distribution == "Rocky" and ansible_distribution_major_version == "9"
